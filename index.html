<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP8266 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .gauges {
      display: flex;
      justify-content: space-around;
      margin-bottom: 40px;
    }
    .card {
      text-align: center;
    }
    .charts {
      display: flex;
      justify-content: space-around;
      gap: 20px;
    }
    .chart-box {
      flex: 1;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>📡 ESP8266 Sensor Dashboard</h2>

  <!-- Hàng trên: Gauge -->
  <div class="gauges">
    <div class="card">
      <h3>Nhiệt độ</h3>
      <canvas id="gaugeTemp"></canvas>
    </div>
    <div class="card">
      <h3>Độ ẩm</h3>
      <canvas id="gaugeHumi"></canvas>
    </div>
    <div class="card">
      <h3>Điện áp</h3>
      <canvas id="gaugeVolt"></canvas>
    </div>
  </div>

  <!-- Hàng dưới: Biểu đồ -->
  <div class="charts">
    <div class="chart-box">
      <h3>Nhiệt độ (24h)</h3>
      <canvas id="chartTemp"></canvas>
    </div>
    <div class="chart-box">
      <h3>Độ ẩm (24h)</h3>
      <canvas id="chartHumi"></canvas>
    </div>
    <div class="chart-box">
      <h3>Điện áp (24h)</h3>
      <canvas id="chartVolt"></canvas>
    </div>
  </div>

  <script>
    const token = "djlxGXmIjuPjubwUqdVCMgB76av9UhNI";

    // Hàm tạo gauge
    function createGauge(elementId, min, max, unit, color) {
      return new RadialGauge({
        renderTo: elementId,
        width: 200,
        height: 200,
        units: unit,
        minValue: min,
        maxValue: max,
        majorTicks: [min, (max/2), max],
        minorTicks: 2,
        strokeTicks: true,
        highlights: [{ from: min, to: max, color: color }],
        colorPlate: "#fff",
        colorNumbers: "#000",
        valueBox: true,
        valueBoxFontColor: "#d32f2f",
        animation: true,
        animationDuration: 500,
        animationRule: "linear",
        needle: true,
        needleCircleSize: 8,
        borders: false,
        value: 0
      }).draw();
    }

    // Tạo 3 gauge
    const gaugeTemp = createGauge("gaugeTemp", 0, 100, "°C", "rgba(103,58,183,0.3)");
    const gaugeHumi = createGauge("gaugeHumi", 0, 100, "%", "rgba(0,150,136,0.3)");
    const gaugeVolt = createGauge("gaugeVolt", 0, 30, "V", "rgba(233,30,99,0.3)");

    // Chart config
    const ctxTemp = document.getElementById('chartTemp').getContext('2d');
    const ctxHumi = document.getElementById('chartHumi').getContext('2d');
    const ctxVolt = document.getElementById('chartVolt').getContext('2d');

    const chartTemp = new Chart(ctxTemp, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'Nhiệt độ (°C)',
        borderColor: '#ff7300',
        backgroundColor: 'rgba(255,115,0,0.2)',
        data: [],
        fill: true,
        tension: 0.3
      }]},
      options: { responsive: true }
    });

    const chartHumi = new Chart(ctxHumi, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'Độ ẩm (%)',
        borderColor: '#00a65a',
        backgroundColor: 'rgba(0,166,90,0.2)',
        data: [],
        fill: true,
        tension: 0.3
      }]},
      options: { responsive: true }
    });

    const chartVolt = new Chart(ctxVolt, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'Điện áp (V)',
        borderColor: '#0070ff',
        backgroundColor: 'rgba(0,112,255,0.2)',
        data: [],
        fill: true,
        tension: 0.3
      }]},
      options: { responsive: true }
    });

    // Hàm lấy dữ liệu từ Blynk
    async function fetchBlynkData() {
      try {
        const [temp, humi, volt] = await Promise.all([
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v1`).then(r => r.json()),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v2`).then(r => r.json()),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v3`).then(r => r.json())
        ]);

        const now = new Date();
        const timeLabel = now.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });

        // Update gauge
        gaugeTemp.value = temp;
        gaugeHumi.value = humi;
        gaugeVolt.value = volt;

        // Update charts
        function updateChart(chart, value) {
          chart.data.labels.push(timeLabel);
          chart.data.datasets[0].data.push(value);
          if(chart.data.labels.length > 288) { // 24h ~ 288 điểm (5 phút/lần)
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }
          chart.update();
        }

        updateChart(chartTemp, temp);
        updateChart(chartHumi, humi);
        updateChart(chartVolt, volt);

      } catch (e) {
        console.error("Error fetch Blynk:", e);
      }
    }

    // Cập nhật mỗi 5 phút
    fetchBlynkData();
    setInterval(fetchBlynkData, 300000);
  </script>
</body>
</html>
