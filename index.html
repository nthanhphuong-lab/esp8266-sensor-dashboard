<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP8266 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .gauges {
      display: flex;
      justify-content: space-around;
      margin-bottom: 40px;
    }
    .card {
      text-align: center;
    }
    canvas {
      max-width: 100%;
    }
    .charts {
      display: flex;
      justify-content: space-around;
    }
    .chart-box {
      width: 48%;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>üì° ESP8266 Sensor Dashboard</h2>

  <!-- H√†ng tr√™n: Gauge -->
  <div class="gauges">
    <div class="card">
      <h3>Nhi·ªát ƒë·ªô</h3>
      <canvas id="gaugeTemp"></canvas>
    </div>
    <div class="card">
      <h3>ƒê·ªô ·∫©m</h3>
      <canvas id="gaugeHumi"></canvas>
    </div>
    <div class="card">
      <h3>ƒêi·ªán √°p</h3>
      <canvas id="gaugeVolt"></canvas>
    </div>
  </div>

  <!-- H√†ng d∆∞·ªõi: Bi·ªÉu ƒë·ªì -->
  <div class="charts">
    <div class="chart-box">
      <h3>Nhi·ªát ƒë·ªô theo th·ªùi gian</h3>
      <canvas id="chartTemp"></canvas>
    </div>
    <div class="chart-box">
      <h3>ƒêi·ªán √°p theo th·ªùi gian</h3>
      <canvas id="chartVolt"></canvas>
    </div>
  </div>

  <script>
    const token = "djlxGXmIjuPjubwUqdVCMgB76av9UhNI";

    // H√†m t·∫°o gauge
    function createGauge(elementId, min, max, unit, color) {
      return new RadialGauge({
        renderTo: elementId,
        width: 250,
        height: 250,
        units: unit,
        minValue: min,
        maxValue: max,
        majorTicks: [min, (max/2), max],
        minorTicks: 2,
        strokeTicks: true,
        highlights: [{ from: min, to: max, color: color }],
        colorPlate: "#fff",
        colorNumbers: "#000",
        valueBox: true,
        animation: true,
        animationDuration: 500,
        animationRule: "linear",
        needle: true,
        needleCircleSize: 8,
        borders: false,
        value: 0
      }).draw();
    }

    // T·∫°o 3 gauge
    const gaugeTemp = createGauge("gaugeTemp", 0, 100, "¬∞C", "rgba(103,58,183,0.3)");
    const gaugeHumi = createGauge("gaugeHumi", 0, 100, "%", "rgba(0,150,136,0.3)");
    const gaugeVolt = createGauge("gaugeVolt", 0, 30, "V", "rgba(233,30,99,0.3)");

    // Chart config
    const ctxTemp = document.getElementById('chartTemp').getContext('2d');
    const ctxVolt = document.getElementById('chartVolt').getContext('2d');

    const chartTemp = new Chart(ctxTemp, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Nhi·ªát ƒë·ªô (¬∞C)',
          borderColor: 'rgba(103,58,183,1)',
          backgroundColor: 'rgba(103,58,183,0.2)',
          data: [],
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    const chartVolt = new Chart(ctxVolt, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ƒêi·ªán √°p (V)',
          borderColor: 'rgba(233,30,99,1)',
          backgroundColor: 'rgba(233,30,99,0.2)',
          data: [],
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // H√†m l·∫•y d·ªØ li·ªáu t·ª´ Blynk API
    async function fetchBlynkData() {
      try {
        const [v1, v2, v3] = await Promise.all([
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v1`).then(r => r.text()),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v2`).then(r => r.text()),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v3`).then(r => r.text())
        ]);

        const now = new Date().toLocaleTimeString();
        const temp = parseFloat(v1) || 0;
        const humi = parseFloat(v2) || 0;
        const volt = parseFloat(v3) || 0;

        // Update gauge
        gaugeTemp.value = temp;
        gaugeHumi.value = humi;
        gaugeVolt.value = volt;

        // Update chart nhi·ªát ƒë·ªô
        chartTemp.data.labels.push(now);
        chartTemp.data.datasets[0].data.push(temp);
        if(chartTemp.data.labels.length > 20) {
          chartTemp.data.labels.shift();
          chartTemp.data.datasets[0].data.shift();
        }
        chartTemp.update();

        // Update chart ƒëi·ªán √°p
        chartVolt.data.labels.push(now);
        chartVolt.data.datasets[0].data.push(volt);
        if(chartVolt.data.labels.length > 20) {
          chartVolt.data.labels.shift();
          chartVolt.data.datasets[0].data.shift();
        }
        chartVolt.update();

      } catch (err) {
        console.error("L·ªói khi g·ªçi API Blynk:", err);
      }
    }

    // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
    fetchBlynkData();
    setInterval(fetchBlynkData, 5000);
  </script>
</body>
</html>
